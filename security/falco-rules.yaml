# ===========================================
# FALCO SECURITY RULES
# ===========================================
# Reglas de seguridad en tiempo de ejecución para LMS Platform

# ===========================================
# REGLAS ESPECÍFICAS PARA LMS PLATFORM
# ===========================================

# Detectar acceso no autorizado a archivos sensibles
- rule: LMS Platform Sensitive File Access
  desc: Detect access to sensitive files in LMS Platform containers
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    (fd.filename in (/etc/passwd, /etc/shadow, /etc/hosts, /etc/ssh/ssh_host_rsa_key) or
     fd.filename startswith /etc/ssl/private or
     fd.filename startswith /app/credentials or
     fd.filename contains ".env")
  output: >
    Sensitive file access in LMS Platform 
    (user=%user.name command=%proc.cmdline file=%fd.name 
     pod=%k8s.pod.name ns=%k8s.ns.name image=%container.image.repository)
  priority: WARNING
  tags: [lms-platform, filesystem, security]

# Detectar ejecución de shells en containers de producción
- rule: LMS Platform Shell Execution
  desc: Detect shell execution in LMS Platform production containers
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    k8s.pod.label.environment="production" and
    spawned_process and
    shell_procs
  output: >
    Shell execution in LMS Platform production container 
    (user=%user.name shell=%proc.name pod=%k8s.pod.name 
     ns=%k8s.ns.name image=%container.image.repository)
  priority: WARNING
  tags: [lms-platform, shell, security]

# Detectar intentos de escalación de privilegios
- rule: LMS Platform Privilege Escalation
  desc: Detect privilege escalation attempts in LMS Platform
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    spawned_process and
    (proc.name in (sudo, su, passwd, chsh, chfn, chage) or
     proc.args contains "--privileged" or
     proc.args contains "setuid" or
     proc.args contains "setgid")
  output: >
    Privilege escalation attempt in LMS Platform 
    (user=%user.name command=%proc.cmdline pod=%k8s.pod.name 
     ns=%k8s.ns.name image=%container.image.repository)
  priority: HIGH
  tags: [lms-platform, privilege-escalation, security]

# Detectar modificaciones de archivos del sistema
- rule: LMS Platform System File Modification
  desc: Detect system file modifications in LMS Platform containers
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    modify and
    (fd.filename startswith /etc or
     fd.filename startswith /usr/bin or
     fd.filename startswith /usr/sbin or
     fd.filename startswith /bin or
     fd.filename startswith /sbin or
     fd.filename startswith /boot or
     fd.filename startswith /lib or
     fd.filename startswith /lib64)
  output: >
    System file modification in LMS Platform 
    (user=%user.name file=%fd.name proc=%proc.name 
     pod=%k8s.pod.name ns=%k8s.ns.name)
  priority: ERROR
  tags: [lms-platform, filesystem, security]

# Detectar conexiones de red sospechosas
- rule: LMS Platform Suspicious Network Activity
  desc: Detect suspicious network connections from LMS Platform
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    inbound and
    (fd.sport in (22, 23, 21, 25, 110, 143, 993, 995) or
     fd.cip.name in (suspicious_ips))
  output: >
    Suspicious network connection to LMS Platform 
    (connection=%fd.name proto=%fd.l4proto sport=%fd.sport 
     pod=%k8s.pod.name ns=%k8s.ns.name)
  priority: WARNING
  tags: [lms-platform, network, security]

# Detectar procesos no esperados
- rule: LMS Platform Unexpected Process
  desc: Detect unexpected processes in LMS Platform containers
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    spawned_process and
    not proc.name in (node, npm, npx, next, prisma, tsx, sh, bash) and
    not proc.pname in (node, npm, npx, next, prisma, tsx)
  output: >
    Unexpected process in LMS Platform container 
    (user=%user.name process=%proc.name cmdline=%proc.cmdline 
     pod=%k8s.pod.name ns=%k8s.ns.name image=%container.image.repository)
  priority: WARNING
  tags: [lms-platform, process, security]

# Detectar intentos de acceso a secretos de Kubernetes
- rule: LMS Platform Secret Access
  desc: Detect attempts to access Kubernetes secrets from LMS Platform
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    open_read and
    fd.filename startswith /var/run/secrets/kubernetes.io/serviceaccount/
  output: >
    Kubernetes secret access in LMS Platform 
    (user=%user.name file=%fd.name proc=%proc.name 
     pod=%k8s.pod.name ns=%k8s.ns.name)
  priority: INFO
  tags: [lms-platform, kubernetes, secrets]

# ===========================================
# REGLAS DE SEGURIDAD GENERALES MEJORADAS
# ===========================================

# Detectar contenedores ejecutándose como root
- rule: LMS Platform Container Running as Root
  desc: Detect LMS Platform containers running as root user
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    user.uid=0 and
    spawned_process
  output: >
    LMS Platform container running as root 
    (user=%user.name command=%proc.cmdline pod=%k8s.pod.name 
     ns=%k8s.ns.name image=%container.image.repository)
  priority: ERROR
  tags: [lms-platform, root, security]

# Detectar montajes de volúmenes sensibles
- rule: LMS Platform Sensitive Volume Mount
  desc: Detect sensitive volume mounts in LMS Platform
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    (k8s.volume.host_path startswith /etc or
     k8s.volume.host_path startswith /var/run/docker.sock or
     k8s.volume.host_path startswith /proc or
     k8s.volume.host_path startswith /sys)
  output: >
    Sensitive volume mount in LMS Platform 
    (volume=%k8s.volume.name path=%k8s.volume.host_path 
     pod=%k8s.pod.name ns=%k8s.ns.name)
  priority: HIGH
  tags: [lms-platform, volume, security]

# Detectar cambios en configuración de red
- rule: LMS Platform Network Configuration Change
  desc: Detect network configuration changes in LMS Platform
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    spawned_process and
    proc.name in (iptables, ip, route, netstat, ss, tc, brctl, ifconfig)
  output: >
    Network configuration change in LMS Platform 
    (user=%user.name command=%proc.cmdline pod=%k8s.pod.name 
     ns=%k8s.ns.name image=%container.image.repository)
  priority: WARNING
  tags: [lms-platform, network, configuration]

# Detectar intentos de instalación de paquetes
- rule: LMS Platform Package Installation
  desc: Detect package installation attempts in LMS Platform
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    spawned_process and
    (proc.name in (apt, apt-get, yum, dnf, zypper, apk, npm, pip, pip3, yarn) or
     proc.cmdline contains "install")
  output: >
    Package installation attempt in LMS Platform 
    (user=%user.name command=%proc.cmdline pod=%k8s.pod.name 
     ns=%k8s.ns.name image=%container.image.repository)
  priority: WARNING
  tags: [lms-platform, package, installation]

# ===========================================
# REGLAS DE COMPLIANCE Y AUDITORÍA
# ===========================================

# Detectar acceso a datos de usuarios
- rule: LMS Platform User Data Access
  desc: Detect access to user data in LMS Platform
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    open_read and
    (fd.filename contains "user" or
     fd.filename contains "profile" or
     fd.filename contains "student" or
     fd.filename contains "personal")
  output: >
    User data access in LMS Platform 
    (user=%user.name file=%fd.name proc=%proc.name 
     pod=%k8s.pod.name ns=%k8s.ns.name)
  priority: INFO
  tags: [lms-platform, data-access, compliance]

# Detectar operaciones de base de datos sensibles
- rule: LMS Platform Database Operation
  desc: Detect sensitive database operations in LMS Platform
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    spawned_process and
    (proc.cmdline contains "DROP" or
     proc.cmdline contains "DELETE" or
     proc.cmdline contains "TRUNCATE" or
     proc.cmdline contains "ALTER")
  output: >
    Sensitive database operation in LMS Platform 
    (user=%user.name command=%proc.cmdline pod=%k8s.pod.name 
     ns=%k8s.ns.name)
  priority: WARNING
  tags: [lms-platform, database, operations]

# ===========================================
# REGLAS DE PERFORMANCE Y RECURSOS
# ===========================================

# Detectar alto uso de CPU
- rule: LMS Platform High CPU Usage
  desc: Detect high CPU usage in LMS Platform containers
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    container.cpu.usage.percent > 80
  output: >
    High CPU usage in LMS Platform 
    (cpu_usage=%container.cpu.usage.percent pod=%k8s.pod.name 
     ns=%k8s.ns.name image=%container.image.repository)
  priority: WARNING
  tags: [lms-platform, performance, cpu]

# Detectar alto uso de memoria
- rule: LMS Platform High Memory Usage
  desc: Detect high memory usage in LMS Platform containers
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    container.memory.usage.percent > 85
  output: >
    High memory usage in LMS Platform 
    (memory_usage=%container.memory.usage.percent pod=%k8s.pod.name 
     ns=%k8s.ns.name image=%container.image.repository)
  priority: WARNING
  tags: [lms-platform, performance, memory]

# ===========================================
# CONFIGURACIÓN DE MACROS
# ===========================================

# Lista de IPs sospechosas (personalizar según necesidades)
- list: suspicious_ips
  items: []

# Lista de procesos permitidos para shell
- list: allowed_shell_processes
  items: [sh, bash, zsh]

# Lista de usuarios de sistema permitidos
- list: system_users
  items: [root, daemon, bin, sys, sync, games, man, lp, mail, news, uucp, proxy, www-data, backup, list, irc, gnats, nobody, systemd-network, systemd-resolve, syslog, messagebus, _apt, lxd, uuidd, dnsmasq, landscape, pollinate, sshd]

# ===========================================
# REGLAS DE EXCEPCIONES
# ===========================================

# Excepción para procesos de inicialización
- rule: LMS Platform Init Process Exception
  desc: Allow init processes in LMS Platform containers
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    proc.name in (init, systemd, dumb-init) and
    proc.pid=1
  output: >
    Init process in LMS Platform container 
    (process=%proc.name pid=%proc.pid pod=%k8s.pod.name 
     ns=%k8s.ns.name)
  priority: INFO
  tags: [lms-platform, init, allowed]

# Excepción para health checks
- rule: LMS Platform Health Check Exception
  desc: Allow health check processes in LMS Platform
  condition: >
    container and
    k8s.ns.name="lms-platform" and
    (proc.cmdline contains "/api/health" or
     proc.cmdline contains "healthcheck" or
     proc.name in (curl, wget))
  output: >
    Health check process in LMS Platform 
    (command=%proc.cmdline pod=%k8s.pod.name 
     ns=%k8s.ns.name)
  priority: INFO
  tags: [lms-platform, health-check, allowed]
